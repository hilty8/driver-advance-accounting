# 経理代行システム V1 仕様書（ドラフト）

## 1. ドキュメント情報

- 名称: 経理代行システム（軽貨物ドライバー向け前借り管理）
- バージョン: v1.1-draft
- 想定読者:
  - 運営会社 O の企画・営業担当
  - システム開発者（CodexCLI で実装を行うエンジニア）
- 目的:
  - 現時点での仕様イメージを明文化し、O・C・開発者間の認識を揃える。
  - 今後の質問・確認のベースとなる仕様ドラフトを提供する。

---

## 2. 背景・目的

### 2.1 背景

- 軽貨物ドライバー（D）は、Cからの報酬の支払サイトが長く（例: 翌々月払い）、手元資金が不足しやすい。
- Dは「前借り」を望むケースが多いが、C担当者に直接依頼するのは心理的ハードルが高い。
- Cは、すでに働いた分を先に支払うこと自体には前向きだが、
  - 誰にいくら前借りを出しているか
  - それがどのタイミングで給与から相殺されているか
  を手作業で管理しており、負荷・ミスのリスクが高い。
- 運営会社 O は、
  - Dの前借りニーズをシステムで受け止めつつ、
  - 前借り管理を自動化し、
  - Dからの手数料収入をベースに事業を成り立たせたい。

### 2.2 本システムの目的

- Dが「スマホから気軽に前借り申請」できる仕組みを提供する。
- Cが「前借り残高・将来の支払予測」を一元管理できるようにする。
- Oが「Cごとの利用状況と収益」を把握・管理できるようにする。
- V1では、前借りに関する範囲にスコープを限定し、会計システム連携などは最小限とする。

---

## 3. スコープ

### 3.1 In Scope（V1）

- D・C・O の 3者を前提とした前借り管理機能
  - D: 残高確認・前借り申請・履歴確認
  - C: 報酬登録・前借り承認/却下・天引き実績登録・残高確認
  - O: Cテナント管理・売上/利用状況ダッシュボード
- 前借り元本・手数料・未回収残高の管理
- 月間利用額、手数料収入、未回収残高、簡易な「回収率」の算出
- CSV 形式での各種一覧・レポート出力
- 支払日や処理日を起点に、残高・ステータス・集計値を自動更新する **日次バッチ処理**

### 3.2 Out of Scope（V1）

- 給与計算システム・会計システムとのリアルタイム API 連携
- 「遅延/延滞」を厳密に扱うリスク管理モデル
- 法的審査・本人確認（KYC）・反社チェック等の与信管理
- 銀行振込 API の実実装（仕様上は想定するが、V1では「手動振込」運用も許容）

---

## 4. 用語定義（抜粋）

### 4.1 関係者

- **ドライバー（Driver, D）**
  - Cから配送業務を受託し、報酬を受け取る個人。
  - 本システム上では、前借り申請の主体。

- **利用企業（Client Company, C）**
  - Dに仕事を依頼し、報酬を支払う企業。
  - 本システム上では、報酬の登録・前借り承認・天引き登録を行う。

- **運営会社（Operator, O）**
  - 本システムを開発・運用し、Cにサービスを提供する企業。

### 4.2 金額関連

- **確定報酬額（Confirmed Earnings）**
  - CがDに対して支払うことを確定した報酬金額。
  - システムで C が登録し、支払月（振込月）単位で管理する。

- **前借り元本（Advance Principal）**
  - Dが前借りした金額の元本（手数料控除前）。

- **前借り手数料（Advance Fee）**
  - Dが前借りを利用する際に負担する手数料。
  - V1想定: 前借り元本の一律 5%。

- **前借り残高（Advance Balance）**
  - 前借り元本のうち、まだ給与から相殺されていない残額の合計。

- **前借り可能額（Advance Limit Amount）**
  - 現時点で D が新たに前借り申請できる上限額。
  - 概念上: 「未振込の確定報酬額 × 上限率」から「前借り残高」を引いたもの。
  - 上限率は C ごとに設定可能なパラメータ（例: 80%）。

- **月間利用額（Monthly Usage Volume）**
  - ある C において、特定の月に D たちが前借りした元本合計（手数料控除前）。

- **システム手数料収入（System Fee Revenue）**
  - D から受け取った前借り手数料の合計。
  - O の主な収益源。

- **回収額（Collected Principal）**
  - 給与支給時の天引きにより、実際に回収できた前借り元本の合計。

- **回収率（Collection Rate, V1簡易版）**
  - 指標例:  
    - 回収率 = 回収済み前借り元本累計 ÷ 立替済み前借り元本累計  
  - V1では「遅延/期日」の概念は持たず、単純な進捗指標とする。

---

## 5. 業務フロー概要

### 5.1 事前設定フロー（C 初期導入時）

1. O が C 用のテナントを作成。
2. C 管理者がログインし、次を設定:
   - 支給サイクル（例: 月1回、〇日締め・〇日払い）
   - 前借り上限率（例: 80%）
   - 手数料率（原則 5% 固定だが、将来変更可能なようにパラメータ化）
3. C が D のアカウントを登録（または招待）:
   - 氏名・連絡先・銀行口座情報・所属支店など。

### 5.2 通常月次フロー

1. **C による報酬登録**
   - 各 D について、当月の「確定報酬額」と「支払月（振込月）」をシステムに登録。
   - 登録方法:
     - 手入力フォーム
     - CSV インポート（V1では最低限の想定）

2. **システムによる前借り可能額の算出**
   - 各 D について、現時点の「未振込の確定報酬額」を集計。
   - 前借り可能額 =  
     `max(0, 未振込確定報酬額の合計 × 上限率 - 現在の前借り残高)`
   - この値を D のマイページに表示。

3. **D による前借り申請**
   - D はマイページを開き、次を確認:
     - 前借り残高
     - 前借りしていない分（未振込の確定報酬）の総額
     - 前借り可能額
     - 今月/翌月/翌々月の振込予定額
   - D は「前借り申請」画面で、希望金額を入力。
     - 入力可能な上限: 前借り可能額

4. **C による前借り承認/却下**
   - C は管理画面で「前借り申請一覧」を確認。
   - 各申請に対して、承認/却下を行う。
   - 承認時:
     - 前借り元本 = 申請金額
     - 手数料 = 前借り元本 × 手数料率（例: 5%）
     - 振込額（Dへの実入金） = 前借り元本 - 手数料
     - 前借り残高に前借り元本を加算
     - 月間利用額に前借り元本を加算

5. **D への振込（立替）**
   - V1では実装方法を柔軟に:
     - A案: システム上に「振込指示」のステータスを持ち、実際の振込はCが銀行から行う。
     - B案: 将来的な銀行API連携を前提に、インターフェースを定義しておく。
   - いずれにせよ、「振込済み」ステータスをシステム上で管理する。

6. **給与支給時の天引き（回収）**
   - 支給日ごとに、C は各 D の「実際に支払うべき給与額」をシステムに登録（手入力またはCSV）。
   - システムは次のロジックで前借り残高を回収:
     - 回収額 `C = min(給与額 S, 前借り残高 B)`
     - 前借り残高 `advance_balance = B - C`
     - Dへの実支給額 `net_salary = S - C`
   - Cは実際の振込処理で上記金額を用いる。
   - 給与支給日の処理やステータス更新は、日次バッチ処理によって自動反映される（→ 5.3 参照）。

### 5.3 日次バッチ処理（支払日・集計の自動更新）

#### 5.3.1 概要

- 毎日1回、指定した時刻（例: 深夜帯）に日次バッチ処理を実行する。
- 日次バッチ処理は、**「システム日付（target_date）」を基準に、支払日が到来したデータを自動更新する**。

#### 5.3.2 主な処理内容

1. **給与支給日の反映**
   - `payrolls` テーブルで、
     - `payout_date <= target_date`
     - かつ「未処理ステータス」のレコードを抽出。
   - 各レコードについて:
     - 回収ロジック（7.3）を適用し、前借り残高・回収額・実支給額を更新。
     - 該当レコードを「処理済み」ステータスに更新。
     - 関連する `earnings` レコードについて、必要に応じて「支払済み」ステータスに更新（※詳細設計で定義）。

2. **D の振込予定額（今月／翌月／翌々月）の再計算**
   - `target_date` 時点を起点として、
     - 「今月」「翌月」「翌々月」を再計算。
   - 各 D について、未振込の確定報酬を支払月別に再集計し、
     - 「今月振込予定額」
     - 「翌月振込予定額」
     - 「翌々月振込予定額」
   - を再計算・キャッシュしておく（マイページ表示用）。

3. **月次メトリクスの更新**
   - `metrics_monthly` テーブルを、`target_date` 時点に合わせて再集計。
   - 集計対象例:
     - 会社別の月間利用額（前借り元本合計）
     - 会社別のシステム手数料収入
     - 会社別の回収額・回収率
     - システム全体の集計値

4. **状態遷移・整合性チェック（簡易）**
   - 前借り残高が0になった `advances` について、必要に応じてステータスを `settled` に更新。
   - 矛盾チェック（例: 前借り残高 < 0 のレコードがないか）を行い、異常をログ出力。

#### 5.3.3 テスト用のバッチ実行インターフェース

- **要件:**
  - テスト段階・検証環境において、日次バッチ処理を手動で実行できること。
  - 実行時に、「target_date（処理対象日）」を任意に指定できること。

- **実装方針（例）:**
  - CLI コマンド:
    - 例: `bin/run_daily_batch --date=2025-10-15`
  - または管理者向け API/エンドポイント:
    - 例: `POST /admin/batch/daily` （bodyに `target_date` を渡す）
  - 本番環境では、通常は `target_date = 実際の当日` とし、cron 等で1日1回自動実行。
  - テスト環境では、シナリオテスト内から `target_date` を変えながら複数回実行できる。

---

## 6. 機能要件

### 6.1 D 向け機能

#### F-D-1: ログイン・認証

- メールアドレス＋パスワード、または C から配布されたログイン情報で認証。
- 将来の多要素認証拡張を考慮して、認証モジュールは抽象化。

#### F-D-2: マイページ（残高・予定表示）

- 表示項目:
  - 現在の前借り残高（元本）
  - 未振込の確定報酬額（前借りしていない分）の総額
  - 前借り可能額
  - 今月・翌月・翌々月の振込予定額
    - 各月について:
      - 総振込予定額
      - うち前借り済み分
      - うち前借りしていない分
- 振込予定額は、日次バッチ処理（5.3）で再計算された値を表示する。

#### F-D-3: 前借り申請

- 入力項目:
  - 申請金額（数値／通貨）
- バリデーション:
  - 0 < 申請金額 ≦ 前借り可能額
- 申請後の動作:
  - ステータス「申請中」で C の承認待ち
  - 申請履歴に追加

#### F-D-4: 前借り履歴

- 一覧項目:
  - 申請日
  - 申請金額
  - 承認/却下ステータス
  - 前借り元本
  - 手数料
  - 振込額
  - 精算状況（例: 精算中/精算済）

---

### 6.2 C 向け機能

#### F-C-1: D アカウント管理

- D の基本情報登録・編集
- 有効/無効フラグ（退職・休職時の対応）

#### F-C-2: 報酬登録

- 単票入力画面:
  - D、仕事月、支払月、確定報酬額を入力
- CSV インポート:
  - D ID、仕事月、支払月、確定報酬額 を含む行を一括インポート
- 登録結果に応じて、D の「未振込報酬額」「前借り可能額」を更新

#### F-C-3: 前借り申請承認/却下

- 申請一覧:
  - D、申請日、申請金額、前借り可能額、ステータス
- 各行で承認/却下ボタン
- 承認時:
  - 前借り元本・手数料・振込額を確定
  - 前借り残高・月間利用額を更新
- 却下時:
  - 却下理由（任意メモ）を登録可能

#### F-C-4: 前借り残高・一覧

- Dごとに:
  - 前借り残高
  - 未振込報酬額
  - 前借り可能額
  - 直近の前借り履歴
- 前借り残高の総額を C 単位で集計

#### F-C-5: 給与支給登録

- 支給日ごとに D の給与額を登録する画面/インポート機能。
  - 入力: D、給与支給日、給与額
- 給与支給登録時点では「予定」として登録し、
  - 日次バッチ処理（5.3）によって実際の回収・ステータス更新を行う。
- 給与支給登録画面では、日次バッチ実行後の結果（回収額・実支給額）も確認できるようにする。

#### F-C-6: C ダッシュボード

- 表示したい指標（候補）:
  - 当月の月間利用額（前借り元本合計）
  - D別の前借り残高ランキング
  - C 全体の前借り残高
  - C 全体の回収率（簡易版）
  - 当月のシステム手数料額（D負担5%の合計）
- CSV エクスポート機能:
  - Dごとの前借り残高一覧
  - 月間利用額・手数料・回収額のサマリ

---

### 6.3 O 向け機能

#### F-O-1: C テナント管理

- C の登録・編集・有効/無効化
- C ごとの設定:
  - 前借り上限率（%）
  - 手数料率（%）
  - 支給サイクルの概要（メモでよい）

#### F-O-2: O ダッシュボード

- 全体視点:
  - C ごとの月間利用額
  - C ごとのシステム手数料収入
  - システム全体の前借り残高総額
  - システム全体の回収率（簡易版）
- C 詳細画面:
  - 個別 C の指標を C ダッシュボード同様に表示

---

## 7. ビジネスロジック詳細

### 7.1 前借り可能額の計算

- パラメータ:
  - `limit_rate`: 前借り上限率（例: 0.8 = 80%）
- 中間値:
  - `unpaid_confirmed_earnings(D)`:
    - まだ振込されていない確定報酬額の合計
- 前借り可能額:
  - `advance_limit(D) = max(0, unpaid_confirmed_earnings(D) * limit_rate - advance_balance(D))`

### 7.2 前借り承認時の金額計算

- 入力:
  - D, C, 申請金額 `R`
- 前提:
  - 0 < R ≦ `advance_limit(D)` をバリデーション済み
- 計算:
  - 前借り元本 `P = R`
  - 手数料率 `fee_rate = 0.05`（V1では固定）
  - 手数料 `F = P * fee_rate`
  - 振込額 `A = P - F`
- 更新:
  - 前借り残高 `advance_balance(D) += P`
  - C の月間利用額 `monthly_usage(C, month(P)) += P`
  - O の手数料収入 `fee_revenue(O, month(P)) += F`

### 7.3 給与支給時の回収ロジック

- 入力:
  - D, 支給日, 給与額 `S`
- 現在の前借り残高:
  - `B = advance_balance(D)`
- 計算:
  - 回収額 `C = min(S, B)`
  - 実支給額 `net_salary = S - C`
- 更新:
  - `advance_balance(D) = B - C`
  - O/C の回収額累計に `C` を加算
  - 回収率の算出に用いる。
- 実装上は、日次バッチ処理（5.3）内で、`target_date` に該当する給与支給分に対してこのロジックを適用する。

### 7.4 回収率の算出（V1簡易）

- 集計期間 T（例: システム開始〜現在）について、
  - 立替済み前借り元本累計 `total_disbursed(T)`
  - 回収済み前借り元本累計 `total_collected(T)`
- 定義:
  - `collection_rate(T) = total_collected(T) / total_disbursed(T)`
- 備考:
  - 貸倒として明示的に「回収不能」とマークした前借り元本は、別途集計し、必要に応じて分母から除外する設計も検討対象。

### 7.5 貸倒（オプション）

- D が退職・長期離脱し、今後給与からの回収が見込めない場合、C または O が「貸倒処理」を実行できるようにする。
- 貸倒処理:
  - 対象の前借り残高の一部または全部を「貸倒額」として記録。
  - `advance_balance(D)` から該当額を減算。
  - 貸倒額は別途集計し、O/C ダッシュボード上で確認可能とする。

### 7.6 日次バッチ処理ロジック

- エントリーポイント:
  - `run_daily_batch(target_date: Date)` のような関数/コマンドを想定。
- 処理順序（概略）:
  1. `target_date` 以前で未処理の `payrolls` を取得。
  2. 各 `payroll` に対して 7.3 の回収ロジックを適用。
  3. 関連する `earnings` を更新（支払済みフラグ等）。
  4. 各 D について、未振込報酬・前借り残高を再集計。
  5. 今月/翌月/翌々月の振込予定額を再計算・キャッシュ。
  6. `metrics_monthly` を更新。
  7. 異常値チェック（負の残高など）を行い、ログ出力。

- テスト環境では、この関数を日付指定で何度も呼べるようにすることで、複数月にまたがるシナリオテストを可能にする。

---

## 8. データモデル（概要）

※ 実際のテーブル名・型は実装側で詳細設計。

- `companies`（C）
  - id
  - name
  - limit_rate
  - fee_rate
  - is_active
  - created_at, updated_at

- `drivers`（D）
  - id
  - company_id
  - name
  - email
  - bank_account_info
  - is_active
  - created_at, updated_at

- `earnings`（確定報酬）
  - id
  - driver_id
  - company_id
  - work_month
  - payout_month
  - amount
  - status（例: confirmed / paid）
  - created_at, updated_at

- `advances`（前借り）
  - id
  - driver_id
  - company_id
  - requested_amount
  - requested_at
  - approved_amount (元本)
  - fee_amount
  - payout_amount
  - status（requested / approved / rejected / paid / settled）
  - created_at, updated_at

- `payrolls`（給与支給）
  - id
  - driver_id
  - company_id
  - payout_date
  - gross_salary_amount
  - advance_collection_amount
  - net_salary_amount
  - status（planned / processed）
  - created_at, updated_at

- `metrics_monthly`（集計メトリクス）
  - id
  - company_id (nullable: null の場合は全体)
  - year_month
  - total_advance_principal
  - total_fee_revenue
  - total_collected_principal
  - total_written_off_principal
  - created_at, updated_at

---

## 9. 画面一覧（概要）

### 9.1 D 画面

- ログイン画面
- マイページ（残高・予定表示）
- 前借り申請画面
- 前借り履歴一覧

### 9.2 C 画面

- C ダッシュボード
- D 一覧・詳細
- 報酬登録画面 / CSV インポート
- 前借り申請一覧（承認/却下）
- 給与支給登録画面 / CSV インポート
- 前借り残高・一覧
- 各種 CSV 出力画面

### 9.3 O 画面

- C テナント一覧・詳細
- O ダッシュボード（C別・全体指標）

---

## 10. 今後の検討・要確認事項メモ

- 月間利用額の厳密な定義（元本合計でよいか）。
- C に対する還元（割引）ロジックを V1 に含めるかどうか。
- 前借り上限率のデフォルト値・変更可能範囲。
- 回収率・貸倒の扱い（V1では遅延は導入しない前提で実装するか）。
- 銀行振込の実装方式（完全手動運用か、将来のAPI連携前提か）。

---

## 11. テスト方針

### 11.1 単体テスト（Unit Test）

- 対象:
  - 前借り可能額計算ロジック（7.1）
  - 前借り承認時の金額計算ロジック（7.2）
  - 給与支給時の回収ロジック（7.3）
  - 日次バッチ処理ロジックの単体関数（7.6 の各ステップ）
- 要件:
  - 境界値テストを含めること
    - 前借り可能額が0のケース
    - 前借り可能額ちょうどの申請
    - 給与額 < 残高、給与額 = 残高、給与額 > 残高 の各パターン
  - 手数料計算の丸め誤差に関するテスト
  - `run_daily_batch(target_date)` を日付パラメータ付きで呼び出し、内部で呼ばれる各関数の動作を検証できるようにする。

### 11.2 シナリオテスト（Scenario / Integration Test）

- 目的:
  - D・C・O の業務フローが、複数月にまたがって期待通りに動作することを検証する。
  - 特に「支払日が来たときに日次バッチ処理が正しくデータを更新するか」を確認する。

- 代表的なシナリオ例:
  1. **単一ドライバー・単月シナリオ**
     - 10月分の確定報酬登録 → 前借り申請 → 承認 → 日次バッチ実行 → 給与支給 → 残高0になるまでの一連の流れを検証。
  2. **複数月にまたがる前借り・回収シナリオ**
     - 10月に8万円前借り → 10月給与5万円、11月給与5万円のパターンで、
       - 10月のバッチ後、残高3万円
       - 11月のバッチ後、残高0
       - 各タイミングのD・C・Oダッシュボードの表示内容を検証。
  3. **複数D・複数Cシナリオ**
     - 複数のDと複数のCを用意し、月間利用額・手数料・回収率集計が正しく行われるか確認。
  4. **貸倒シナリオ（オプション）**
     - Dの退職を想定し、貸倒処理を行った場合に、残高・メトリクスが意図通りに更新されるか確認。

- テスト実行方法:
  - シナリオテスト内で、日次バッチを任意の日付で複数回呼び出せるようにする。
    - 例:
      - `run_daily_batch('2025-10-31')`
      - `run_daily_batch('2025-11-30')`
  - これにより、「時系列を進めながら状態がどう変化するか」を自動テストで再現可能にする。

- 成果物:
  - 単体テスト・シナリオテストともに、自動テストフレームワーク（例: Jest / PHPUnit / pytest など、技術選定に応じて）で実装し、
  - `npm test` / `pnpm test` などの単一コマンドでフルテストが実行できる状態にすること。

---
