# 日次バッチ冪等性テストケース (v2 準拠)

## 対応する Feature/SF

- F06/SF02（給与確定）
- テストタグ（予定）: `@F06 @SF02`

`docs/test-catalog.md` に従い、E2E 追加時にテストタグで紐づける。

- 前提: `runDailyBatch(targetDate)` は同一日付で複数回実行しても集計・残高が二重計上されない。
- 手数料は承認時に計上済み、回収は collection のみ。

## 単一ドライバー

1. **給与<残高（単一回収）**
   - 残高 80,000 円、給与 50,000 円。
   - target_date 当日のバッチを 2 回実行しても collection 合計 50,000 円で変わらないこと。
2. **給与=残高（完済）**
   - 残高 50,000 円、給与 50,000 円。
   - 2 回実行しても残高 0 で `settled` のまま変化しないこと。
3. **給与>残高（余剰あり）**
   - 残高 30,000 円、給与 50,000 円。
   - 2 回実行しても collection 30,000 円で固定、残高 0 のまま。

## 複数月シナリオ

4. **10月・11月の給与を 1 日で連続処理**
   - 10/31 と 11/30 の payroll を用意し、target_date=2025-11-30 で一括実行。
   - 同日2回実行しても、10月分+11月分の collection が二重にならない。

5. **月跨ぎ連続実行**
   - target_date=2025-10-31 実行後、同日で再実行 → 差分なし。
   - 翌日 target_date=2025-11-01 実行 → 新規対象なしで差分なし。

## 複数ドライバー/複数C

6. **ドライバー A/B 同日支給**
   - A/B の payroll が同じ日にあり、残高・給与が異なる。
   - 2 回実行しても driver_balances_materialized と metrics_monthly が各ドライバー・各 C で二重計上されない。

7. **異なる会社の payroll が同日**
   - C1/C2 の payroll を同日処理。
   - metrics_monthly の company_id 単位集計と全体集計が一貫して冪等。

## 貸倒混在

8. **貸倒後のバッチ**
   - target_date 前に write_off が入っているケース。
   - 同日実行しても write_off を重複考慮せず、残高再計算が安定。

## 異常系チェック

9. **対象 payroll なし**
   - planned なしで実行しても副作用ゼロ、2 回実行しても同じ結果。
10. **負残チェック**
    - 残高が負になるデータを意図的に入れ、バッチが例外を出さずログのみを残す（副作用が再実行で変わらない）。
